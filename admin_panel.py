# admin_panel.py

import os
import logging
import csv
import io
import asyncio
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CommandHandler, CallbackQueryHandler
from telegram.error import TelegramError

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
ADMIN_IDS = list(map(int, os.environ.get("ADMIN_IDS", "").split(','))) if os.environ.get("ADMIN_IDS") else []

# ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…Ø¯ÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
import data_manager

logger = logging.getLogger(__name__)

# --- Ø¯Ú©ÙˆØ±Ø§ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† ---

def admin_only(func):
    """Ø§ÛŒÙ† Ø¯Ú©ÙˆØ±Ø§ØªÙˆØ± ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø¨ØªÙˆØ§Ù†Ù†Ø¯ Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†Ù†Ø¯."""
    async def wrapped(update: Update, context: ContextTypes.DEFAULT_TYPE, *args, **kwargs):
        if update.effective_user.id not in ADMIN_IDS:
            await update.message.reply_text("â›”ï¸ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
            return
        return await func(update, context, *args, **kwargs)
    return wrapped

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¯Ù…ÛŒÙ† ---

@admin_only
async def admin_commands(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†."""
    commands_text = (
        "ğŸ“‹ **Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¯Ù…ÛŒÙ† Ø±Ø¨Ø§Øª:**\n\n"
        "ğŸ“Š `/stats` - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª\n"
        "ğŸ“¢ `/broadcast [Ù¾ÛŒØ§Ù…]` - Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†\n"
        "ğŸš« `/ban [Ø¢ÛŒØ¯ÛŒ]` - Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±\n"
        "âœ… `/unban [Ø¢ÛŒØ¯ÛŒ]` - Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø±\n"
        "â„¹ï¸ `/user_info [Ø¢ÛŒØ¯ÛŒ]` - Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±\n"
        "ğŸ“ `/logs` - Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª\n"
        "ğŸ‘¥ `/users_list [ØµÙØ­Ù‡]` - Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†\n"
        "ğŸ” `/user_search [Ù†Ø§Ù…]` - Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…\n"
        "ğŸ’¾ `/backup` - Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§\n"
        "ğŸ“‹ `/commands` - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø¯Ø³ØªÙˆØ±Ø§Øª"
    )
    await update.message.reply_text(commands_text, parse_mode='Markdown')

@admin_only
async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ…Ø±Ú©Ø²
    total_users = len(data_manager.DATA['users'])
    total_messages = data_manager.DATA['stats']['total_messages']
    banned_count = len(data_manager.DATA['banned_users'])
    
    now = datetime.now()
    active_24h = sum(1 for user in data_manager.DATA['users'].values() 
                    if 'last_seen' in user and 
                    datetime.strptime(user['last_seen'], '%Y-%m-%d %H:%M:%S') > now - timedelta(hours=24))
    
    active_7d = sum(1 for user in data_manager.DATA['users'].values() 
                   if 'last_seen' in user and 
                   datetime.strptime(user['last_seen'], '%Y-%m-%d %H:%M:%S') > now - timedelta(days=7))

    active_users = sorted(
        data_manager.DATA['users'].items(),
        key=lambda item: item[1].get('last_seen', ''),
        reverse=True
    )[:5]

    active_users_text = "\n".join(
        [f"â€¢ {user_id}: {info.get('first_name', 'N/A')} (Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: {info.get('last_seen', 'N/A')})"
         for user_id, info in active_users]
    )

    text = (
        f"ğŸ“Š **Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª**\n\n"
        f"ğŸ‘¥ **ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:** `{total_users}`\n"
        f"ğŸ“ **ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:** `{total_messages}`\n"
        f"ğŸš« **Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡:** `{banned_count}`\n"
        f"ğŸŸ¢ **Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ 24 Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡:** `{active_24h}`\n"
        f"ğŸŸ¢ **Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ 7 Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡:** `{active_7d}`\n\n"
        f"**Ûµ Ú©Ø§Ø±Ø¨Ø± Ø§Ø®ÛŒØ± ÙØ¹Ø§Ù„:**\n{active_users_text}"
    )
    await update.message.reply_text(text, parse_mode='Markdown')

@admin_only
async def admin_broadcast(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ÛŒÚ© Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ù‡ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    if not context.args:
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/broadcast Ø³Ù„Ø§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡!`")
        return

    message_text = " ".join(context.args)
    user_ids = list(data_manager.DATA['users'].keys())
    total_sent = 0
    total_failed = 0

    await update.message.reply_text(f"ğŸ“£ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ `{len(user_ids)}` Ú©Ø§Ø±Ø¨Ø±...")

    for user_id_str in user_ids:
        try:
            await context.bot.send_message(chat_id=int(user_id_str), text=message_text)
            total_sent += 1
            await asyncio.sleep(0.05)
        except TelegramError as e:
            logger.warning(f"Failed to send broadcast to {user_id_str}: {e}")
            total_failed += 1

    result_text = (
        f"âœ… **Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯**\n\n"
        f"âœ… Ù…ÙˆÙÙ‚: `{total_sent}`\n"
        f"âŒ Ù†Ø§Ù…ÙˆÙÙ‚: `{total_failed}`"
    )
    await update.message.reply_text(result_text, parse_mode='Markdown')

@admin_only
async def admin_ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    if not context.args or not context.args[0].isdigit():
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/ban 123456789`")
        return

    user_id_to_ban = int(context.args[0])

    if user_id_to_ban in ADMIN_IDS:
        await update.message.reply_text("ğŸ›¡ï¸ Ø´Ù…Ø§ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯!")
        return

    if data_manager.is_user_banned(user_id_to_ban):
        await update.message.reply_text(f"Ú©Ø§Ø±Ø¨Ø± `{user_id_to_ban}` Ø§Ø² Ù‚Ø¨Ù„ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        return

    data_manager.ban_user(user_id_to_ban)
    await update.message.reply_text(f"âœ… Ú©Ø§Ø±Ø¨Ø± `{user_id_to_ban}` Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.", parse_mode='Markdown')

@admin_only
async def admin_unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø³Ø¯ÙˆØ¯ÛŒØª ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯."""
    if not context.args or not context.args[0].isdigit():
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/unban 123456789`")
        return

    user_id_to_unban = int(context.args[0])

    if not data_manager.is_user_banned(user_id_to_unban):
        await update.message.reply_text(f"Ú©Ø§Ø±Ø¨Ø± `{user_id_to_unban}` Ø¯Ø± Ù„ÛŒØ³Øª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
        return

    data_manager.unban_user(user_id_to_unban)
    await update.message.reply_text(f"âœ… Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± `{user_id_to_unban}` Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯.", parse_mode='Markdown')

@admin_only
async def admin_userinfo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
    if not context.args or not context.args[0].isdigit():
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/user_info 123456789`")
        return

    user_id = int(context.args[0])
    user_info = data_manager.DATA['users'].get(str(user_id))

    if not user_info:
        await update.message.reply_text(f"Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ `{user_id}` Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        return

    is_banned = "Ø¨Ù„Ù‡" if data_manager.is_user_banned(user_id) else "Ø®ÛŒØ±"
    
    if 'first_seen' in user_info and 'last_seen' in user_info:
        first_date = datetime.strptime(user_info['first_seen'], '%Y-%m-%d %H:%M:%S')
        last_date = datetime.strptime(user_info['last_seen'], '%Y-%m-%d %H:%M:%S')
        days_active = max(1, (last_date - first_date).days)
        avg_messages = user_info.get('message_count', 0) / days_active
    else:
        avg_messages = user_info.get('message_count', 0)
    
    text = (
        f"â„¹ï¸ **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±**\n\n"
        f"ğŸ†” **Ø¢ÛŒØ¯ÛŒ:** `{user_id}`\n"
        f"ğŸ‘¤ **Ù†Ø§Ù…:** {user_info.get('first_name', 'N/A')}\n"
        f"ğŸ”· **Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:** @{user_info.get('username', 'N/A')}\n"
        f"ğŸ“Š **ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:** `{user_info.get('message_count', 0)}`\n"
        f"ğŸ“ˆ **Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¯Ø± Ø±ÙˆØ²:** `{avg_messages:.2f}`\n"
        f"ğŸ“… **Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…:** {user_info.get('first_seen', 'N/A')}\n"
        f"ğŸ•’ **Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª:** {user_info.get('last_seen', 'N/A')}\n"
        f"ğŸš« **ÙˆØ¶Ø¹ÛŒØª Ù…Ø³Ø¯ÙˆØ¯ÛŒØª:** {is_banned}"
    )
    await update.message.reply_text(text, parse_mode='Markdown')

@admin_only
async def admin_logs(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¢Ø®Ø±ÛŒÙ† Ø®Ø·ÙˆØ· Ù„Ø§Ú¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    try:
        with open(data_manager.LOG_FILE, "r", encoding="utf-8") as f:
            lines = f.readlines()
            last_lines = lines[-30:]
            log_text = "".join(last_lines)
            if not log_text:
                await update.message.reply_text("ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.")
                return
            
            if len(log_text) > 4096:
                for i in range(0, len(log_text), 4096):
                    await update.message.reply_text(f"```{log_text[i:i+4096]}```", parse_mode='Markdown')
            else:
                await update.message.reply_text(f"```{log_text}```", parse_mode='Markdown')

    except FileNotFoundError:
        await update.message.reply_text("ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
    except Exception as e:
        await update.message.reply_text(f"Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù„Ø§Ú¯ Ø±Ø® Ø¯Ø§Ø¯: {e}")

@admin_only
async def admin_users_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ."""
    users = data_manager.DATA['users']
    
    page = 1
    if context.args and context.args[0].isdigit():
        page = int(context.args[0])
        if page < 1: page = 1
    
    users_per_page = 20
    total_users = len(users)
    total_pages = (total_users + users_per_page - 1) // users_per_page
    
    if page > total_pages: page = total_pages
    
    start_idx = (page - 1) * users_per_page
    end_idx = min(start_idx + users_per_page, total_users)
    
    sorted_users = sorted(users.items(), key=lambda item: item[1].get('last_seen', ''), reverse=True)
    
    users_text = f"ğŸ‘¥ **Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (ØµÙØ­Ù‡ {page}/{total_pages})**\n\n"
    
    for i, (user_id, user_info) in enumerate(sorted_users[start_idx:end_idx], start=start_idx + 1):
        is_banned = "ğŸš«" if int(user_id) in data_manager.DATA['banned_users'] else "âœ…"
        username = user_info.get('username', 'N/A')
        first_name = user_info.get('first_name', 'N/A')
        last_seen = user_info.get('last_seen', 'N/A')
        message_count = user_info.get('message_count', 0)
        
        users_text += f"{i}. {is_banned} `{user_id}` - {first_name} (@{username})\n"
        users_text += f"   Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: `{message_count}` | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: `{last_seen}`\n\n"
    
    keyboard = []
    if page > 1: keyboard.append([InlineKeyboardButton("â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„", callback_data=f"users_list:{page-1}")])
    if page < total_pages: keyboard.append([InlineKeyboardButton("â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯", callback_data=f"users_list:{page+1}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
    await update.message.reply_text(users_text, parse_mode='Markdown', reply_markup=reply_markup)

@admin_only
async def admin_user_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ."""
    if not context.args:
        await update.message.reply_text("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\nÙ…Ø«Ø§Ù„: `/user_search Ø¹Ù„ÛŒ`")
        return
    
    search_term = " ".join(context.args).lower()
    users = data_manager.DATA['users']
    
    matching_users = []
    for user_id, user_info in users.items():
        first_name = user_info.get('first_name', '').lower()
        username = user_info.get('username', '').lower()
        
        if search_term in first_name or search_term in username:
            is_banned = "ğŸš«" if int(user_id) in data_manager.DATA['banned_users'] else "âœ…"
            matching_users.append((user_id, user_info, is_banned))
    
    if not matching_users:
        await update.message.reply_text(f"Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ù†Ø§Ù… Â«{search_term}Â» ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        return
    
    results_text = f"ğŸ” **Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Â«{search_term}Â»**\n\n"
    
    for user_id, user_info, is_banned in matching_users:
        username = user_info.get('username', 'N/A')
        first_name = user_info.get('first_name', 'N/A')
        last_seen = user_info.get('last_seen', 'N/A')
        message_count = user_info.get('message_count', 0)
        
        results_text += f"{is_banned} `{user_id}` - {first_name} (@{username})\n"
        results_text += f"   Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: `{message_count}` | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: `{last_seen}`\n\n"
    
    await update.message.reply_text(results_text, parse_mode='Markdown')

@admin_only
async def admin_backup(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª."""
    try:
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        backup_file = f"bot_backup_{timestamp}.json"
        
        data_to_backup = data_manager.DATA.copy()
        data_to_backup['banned_users'] = list(data_manager.DATA['banned_users'])
        
        with open(backup_file, 'w', encoding='utf-8') as f:
            json.dump(data_to_backup, f, indent=4, ensure_ascii=False)
        
        await update.message.reply_document(
            document=open(backup_file, 'rb'),
            caption=f"âœ… Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {backup_file}"
        )
        
        logger.info(f"Backup created: {backup_file}")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†: {e}")
        logger.error(f"Error creating backup: {e}")

# --- Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ---
async def users_list_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†."""
    query = update.callback_query
    await query.answer()
    
    if query.data.startswith("users_list:"):
        page = int(query.data.split(":")[1])
        context.args = [str(page)]
        await admin_users_list(update, context)

# --- ØªØ§Ø¨Ø¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ ---
def setup_admin_handlers(application):
    """Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    application.add_handler(CommandHandler("commands", admin_commands))
    application.add_handler(CommandHandler("stats", admin_stats))
    application.add_handler(CommandHandler("broadcast", admin_broadcast))
    application.add_handler(CommandHandler("ban", admin_ban))
    application.add_handler(CommandHandler("unban", admin_unban))
    application.add_handler(CommandHandler("user_info", admin_userinfo))
    application.add_handler(CommandHandler("logs", admin_logs))
    application.add_handler(CommandHandler("users_list", admin_users_list))
    application.add_handler(CommandHandler("user_search", admin_user_search))
    application.add_handler(CommandHandler("backup", admin_backup))
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
    application.add_handler(CallbackQueryHandler(users_list_callback, pattern="^users_list:"))
    
    logger.info("Admin panel handlers have been set up.")
