# data_manager.py

import os
import json
import logging
from datetime import datetime

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ---
# Ù…Ø³ÛŒØ± Ù¾ÙˆØ´Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_FILE = os.path.join(BASE_DIR, "bot_data.json")
LOG_FILE = os.path.join(BASE_DIR, "bot.log")

# --- Ú©Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„ ---
# Ø§ÛŒÙ† Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒØŒ Ø­Ø§ÙØ¸Ù‡ Ø§ØµÙ„ÛŒ Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø³Øª.
DATA = {
    "users": {},
    "banned_users": set(),
    "stats": {
        "total_messages": 0,
        "total_users": 0
    },
    "welcome_message": "Ø³Ù„Ø§Ù… {user_mention}! ðŸ¤–\n\nÙ…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‡Ø³ØªÙ…. Ù‡Ø± Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØ¯ Ø¨Ù¾Ø±Ø³ÛŒØ¯.",
    "goodbye_message": "Ú©Ø§Ø±Ø¨Ø± {user_mention} Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ØªØ±Ú© Ú©Ø±Ø¯. Ø®Ø¯Ø§Ø­Ø§ÙØ¸!",
    "maintenance_mode": False
}

logger = logging.getLogger(__name__)

def load_data():
    """Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² ÙØ§ÛŒÙ„ JSON Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ú©Ø´ Ú¯Ù„ÙˆØ¨Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    global DATA
    try:
        if not os.path.exists(DATA_FILE):
            logger.info(f"ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø¯Ø± {DATA_FILE} ÛŒØ§ÙØª Ù†Ø´Ø¯. ÛŒÚ© ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            save_data() # ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            return

        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            loaded_data = json.load(f)
            # ØªØ¨Ø¯ÛŒÙ„ Ù„ÛŒØ³Øª Ø¢ÛŒØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ù‡ set Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ±
            loaded_data['banned_users'] = set(loaded_data.get('banned_users', []))
            DATA.update(loaded_data)
            logger.info(f"Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² {DATA_FILE} Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.")

    except json.JSONDecodeError as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† JSON Ø§Ø² {DATA_FILE}: {e}. Ø±Ø¨Ø§Øª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: {e}. Ø±Ø¨Ø§Øª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.")

def save_data():
    """Ú©Ø´ Ú¯Ù„ÙˆØ¨Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ JSON Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    global DATA
    try:
        # Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ØŒ set Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú†ÙˆÙ† JSON Ø§Ø² set Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        data_to_save = DATA.copy()
        data_to_save['banned_users'] = list(DATA['banned_users'])
        
        with open(DATA_FILE, 'w', encoding='utf-8') as f:
            json.dump(data_to_save, f, indent=4, ensure_ascii=False)
        logger.debug(f"Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± {DATA_FILE} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ù…Ù‡Ù„Ú©: Ø§Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± {DATA_FILE} ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø®Ø·Ø§: {e}")

def update_user_stats(user_id: int, user):
    """Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù¾Ø³ Ø§Ø² Ù‡Ø± Ù¾ÛŒØ§Ù… Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    global DATA
    now_str = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    user_id_str = str(user_id)
    
    if user_id_str not in DATA['users']:
        DATA['users'][user_id_str] = {
            'first_name': user.first_name,
            'username': user.username,
            'first_seen': now_str,
            'message_count': 0
        }
        DATA['stats']['total_users'] += 1
        logger.info(f"Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯: {user_id} ({user.first_name})")

    DATA['users'][user_id_str]['last_seen'] = now_str
    DATA['users'][user_id_str]['message_count'] += 1
    DATA['stats']['total_messages'] += 1
    
    # Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡ØŒ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    save_data()

def is_user_banned(user_id: int) -> bool:
    """Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±."""
    return user_id in DATA['banned_users']

def ban_user(user_id: int):
    """Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    DATA['banned_users'].add(user_id)
    save_data()

def unban_user(user_id: int):
    """Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    DATA['banned_users'].discard(user_id)
    save_data()

# Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø´Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„
load_data()
